#!/usr/bin/env perl
use 5.010;
use autodie;
use strict;
use File::Path qw(remove_tree make_path);

chomp(my @domains = qx[ grep -h ORIGIN /etc/bind/master/master* | $^X -pe 's/^.*? (.*?)\.\$/\$1/' ]);
my @ns = (qw(localhost), map({ "ns$_.1984.is" } 0 .. 2), (map { "ns$_.linode.com" } 1..5));

my @subdomain_tests = qw(A NS MX);
my @domain_tests    = ("SOA", @subdomain_tests, "AXFR");

remove_tree('/etc/bind/t/gen');

for my $domain (@domains) {
    my @tests = is_subdomain($domain) ? @subdomain_tests : @domain_tests;

    for my $ns (@ns[1..$#ns]) {
        my $test = <<TEST;
# DO NOT EDIT, AUTOGENERATED
use lib '/etc/bind/t/lib';
use DomainTest;
DomainTest->new(
    domain  => q[$domain],
    servers => [ qw[ $ns[0] $ns ] ],
    tests   => [ qw[ @tests ] ],
)->run_tests;
TEST
        my $dir = "/etc/bind/t/gen/$ns";
        make_path($dir);
        open my $th, ">", "$dir/$domain.t";
        print $th $test;
        close $th;
    }
}

sub is_subdomain
{
    my $domain = shift;
    my $dots  = () = $domain =~ /\./g;

    $dots != 1;
}
