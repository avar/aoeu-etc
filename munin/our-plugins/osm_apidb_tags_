#!/usr/bin/env perl
use Modern::Perl;
use Munin::Plugin;
use DBI;
use String::Truncate qw(elide);
use Encode;

binmode STDOUT, ":utf8";

my $user = $ENV{PGUSER};
my $pass = $ENV{PGPASSWORD};
my $host = $ENV{PGHOST} // 'localhost';
my $port = $ENV{PGPORT} // 5432;
my $dbnm = $ENV{PGDATABASE};

# Black/whitelist
my @k_blacklist = split /\s+/, $ENV{k_blacklist} // '';
my @k_whitelist = split /\s+/, $ENV{k_whitelist} // '';

my @where;
push @where => map { qq[k != '$_'] } @k_blacklist;
push @where => map { qq[k  = '$_'] } @k_whitelist;
my $where = join ' AND ', @where; 

my $l_v_only = $ENV{label_v_only};
my $limit = $ENV{limit};
my $what = $ENV{primitive}; $what =~ s/s$//;
my $What = ucfirst $what;
my $whats = $what.'s';
my $Whats = $What.'s';
my $title = $ENV{graph_title} // "The number of $what tags in OSM by key=value";
my $desc = $ENV{graph_info}   // "The number of $what tags in the OpenStreetMap database by key=value";

my $dbh = DBI->connect("dbi:Pg:dbname=$dbnm;host=$host;port=$port", $user, $pass);
my $query = <<QUERY;
SELECT count(*) as c, k, v
FROM current_${what}_tags
WHERE $where
GROUP BY k, v ORDER BY c DESC LIMIT $limit;
QUERY

my @tags = @{ $dbh->selectall_arrayref($query) };

given ($ARGV[0]) {
    when ("config") {
        print <<END;
graph_title $title
graph_args --base 1000 -l 0
graph_vlabel $what tags properties
graph_category OpenStreetMap
graph_info $desc
END
        for my $tag (@tags) {
            my ($count, $k, $v) = @$tag;
            my $fieldname = clean_fieldname("$k=$v");
            my $label = $l_v_only ? $v : "$k=$v";
            my $l = decode('utf-8', $label);
            $label = elide($l, 30, { truncate => 'middle' });
            print <<END;
$fieldname.info The number of ${what} tags with $k=$v
$fieldname.label $label
$fieldname.type GAUGE
END
        }
    }
    default {
        for my $tag (@tags) {
            my ($count, $k, $v) = @$tag;
            my $fieldname = clean_fieldname("$k=$v");
            print <<END;
$fieldname.value $count
END
}
    }
}
