#!/usr/bin/env perl
use autodie;
use Modern::Perl;
use Apache::ConfigParser;
use Template;
use Data::Dump 'dump';

my @configs = glob "/etc/apache2/sites-enabled/*";
my $DATA = join '', <DATA>;

for my $config (@configs) {
    my ($servername, @serveralias) = get_servername_serveralias($config);
    my $config = get_config($servername, @serveralias);

    open my $fh, ">", "/etc/awstats/awstats.$servername.conf";
    print $fh $config;
    close $fh;
}

sub get_config {
    my ($servername, @serveralias) = @_;

    my $ret;

    Template->new->process(
        \$DATA,
        {
            program     => $0,
            servername  => $servername,
            serveralias => \@serveralias,
        },
        \$ret,
    );

    return $ret;
}

sub get_servername_serveralias {
    my $file = shift;

    my $c1 = Apache::ConfigParser->new;
    my $rc = $c1->parse_file($file);

    unless ($rc) {
        say STDERR $c1->errstr;
        exit 1;
    }

    my $root = $c1->root;

    my @directives = $root->daughters;

    # Get the first directive's name.
    my (@d) =$directives[0]->daughters;

    my ($servername, @serveralias);

    $servername  = $d[0]->value if $d[0]->name eq 'servername';
    @serveralias = $d[1]->value if $d[1]->name eq 'serveralias';


    return ($servername, @serveralias);
}

__DATA__
# This configuration file has been generated by [% program %]
# do not edit directly or check into Git

Include "/etc/awstats/awstats.conf"
# LogFile="/var/log/apache2/[% servername %]/access.log"
LogFile="/var/log/apache2/access.log"
SiteDomain="[% servername %]"
HostAliases="[% servername %] [% serveralias.join(' ') %]"
